<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BR Admin DB</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { background: #121212; color: #eee; font-family: 'Segoe UI', monospace; padding: 20px; margin: 0; box-sizing: border-box; }
        input, textarea, select { -webkit-user-select: text; user-select: text; }
        h2, h3, h4 { color: #FFD700; margin-top: 0; }
        #login-overlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-box { background: #1e1e1e; padding: 30px; border: 1px solid #333; border-radius: 12px; text-align: center; width: 300px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .container { display: grid; grid-template-columns: 280px 1fr; gap: 20px; }
        @media (max-width: 800px) { .container { grid-template-columns: 1fr; } }
        .sidebar { background: #1e1e1e; padding: 15px; border: 1px solid #333; border-radius: 8px; height: fit-content; max-height: 80vh; overflow-y: auto; }
        .editor { background: #1e1e1e; padding: 20px; border: 1px solid #333; border-radius: 8px; }
        button { cursor: pointer; padding: 10px; border: none; font-weight: bold; width: 100%; margin-bottom: 5px; border-radius: 4px; transition: 0.2s; }
        button:hover { filter: brightness(1.1); }
        .btn-green { background: #4CAF50; color: white; }
        .btn-red { background: #ff4d4d; color: white; }
        .btn-gold { background: #FFD700; color: black; }
        .btn-blue { background: #2196F3; color: white; }
        .btn-gray { background: #444; color: #ccc; font-size: 12px; }
        .btn-item { background: #2a2a2a; color: white; text-align: left; border-bottom: 1px solid #333; padding: 12px; }
        .btn-item:hover { background: #333; }
        .btn-item.active { background: #FFD700; color: black; border-color: #FFD700; }
        input, select, textarea { width: 100%; padding: 10px; margin-bottom: 10px; background: #121212; border: 1px solid #444; color: white; box-sizing: border-box; border-radius: 4px; }
        label { display: block; font-size: 12px; color: #aaa; margin-bottom: 4px; font-weight: bold; }
        .items-header { display: grid; grid-template-columns: 50px 2fr 1fr 1.5fr 40px; gap: 10px; padding: 0 10px; font-size: 12px; color: #888; margin-bottom: 5px; }
        .item-row { display: grid; grid-template-columns: 50px 2fr 1fr 1.5fr 40px; gap: 10px; align-items: start; background: #252525; padding: 10px; margin-bottom: 8px; border-left: 4px solid #555; border-radius: 4px; }
        .item-img-preview { width: 40px; height: 40px; object-fit: contain; background: #000; border-radius: 4px; border: 1px solid #333; pointer-events: none; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; background: #1e1e1e; padding: 5px; border-radius: 8px; }
        .tab-btn { background: transparent; color: #aaa; flex: 1; padding: 12px; text-align: center; cursor: pointer; border-radius: 6px; font-weight: 600; }
        .tab-btn.active { background: #333; color: #FFD700; }
        .chances-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 20px; padding: 15px; background: #181818; border: 1px solid #333; border-radius: 6px; }
        .border-consumer { border-left-color: #B0B0B0; } .border-common { border-left-color: #4CAF50; } .border-rare { border-left-color: #2196F3; } .border-epic { border-left-color: #9C27B0; } .border-legendary { border-left-color: #FFD700; } .border-mythical { border-left-color: #FF0055; }
        .promo-row { display: grid; grid-template-columns: 2fr 1fr 1fr 40px; gap: 10px; background: #252525; padding: 10px; margin-bottom: 5px; border-radius: 4px; border-left: 4px solid gold; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h3>üîê ADMIN ACCESS</h3>
            <input type="text" id="admin-user" placeholder="Username">
            <input type="password" id="admin-pass" placeholder="Password">
            <button class="btn-gold" onclick="login()">–í–û–ô–¢–ò</button>
            <div id="login-error" style="color:red; margin-top:10px; font-size:12px;"></div>
        </div>
    </div>

    <div class="header">
        <div>
            <h2>‚öôÔ∏è ADMIN PANEL</h2>
            <div style="font-size: 12px; color: #666;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</div>
        </div>
        <div style="display:flex; gap:10px;">
             <button onclick="logout()" class="btn-gray" style="width: auto;">–í—ã–π—Ç–∏</button>
        </div>
    </div>

    <div class="tabs">
        <div class="tab-btn active" onclick="setMode('cases')" id="tab-cases">üì¶ –ö–ï–ô–°–´ (DB)</div>
        <div class="tab-btn" onclick="setMode('promos')" id="tab-promos">üéü –ü–†–û–ú–û–ö–û–î–´</div>
        <div class="tab-btn" onclick="setMode('broadcast')" id="tab-broadcast">üì¢ –†–ê–°–°–´–õ–ö–ê</div>
    </div>

    <div class="container" id="view-cases">
        <div class="sidebar">
            <h3 style="margin: 0 0 10px 0; font-size: 14px; text-transform: uppercase; color: #666;">–°–ø–∏—Å–æ–∫ –ö–µ–π—Å–æ–≤</h3>
            <div id="cases-list"><div style="text-align:center; padding:10px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
            <button class="btn-green" style="margin-top: 10px;" onclick="createNewLocalCase()">+ –ù–æ–≤—ã–π –ö–µ–π—Å</button>
        </div>

        <div class="editor" id="editor-area" style="display:none;">
            <div style="display: flex; gap: 20px; align-items: flex-start; margin-bottom: 20px;">
                <img id="case-img-preview" src="" style="width: 80px; height: 80px; object-fit: contain; background: #111; border: 1px solid #333; border-radius: 8px;">
                <div style="flex: 1;">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–µ–π—Å–∞:</label>
                    <input type="text" id="case-name" oninput="updatePreview()">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <div>
                            <label>–¶–µ–Ω–∞ (‚ÇΩ):</label>
                            <input type="number" id="case-price" oninput="updatePreview()">
                        </div>
                        <div>
                            <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
                            <select id="case-category">
                                <option value="default">–û–±—ã—á–Ω—ã–µ</option>
                                <option value="bundles">–ù–∞–±–æ—Ä—ã</option>
                                <option value="risk">–í—Å—ë –∏–ª–∏ –ù–∏—á–µ–≥–æ</option>
                                <option value="free">–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π</option>
                                <option value="container">–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã</option>
                            </select>
                        </div>
                        <div>
                            <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞ (URL):</label>
                            <input type="text" id="case-img" oninput="updatePreview()">
                        </div>
                    </div>
                </div>
            </div>

            <h4 style="border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 10px;">üé≤ –®–∞–Ω—Å—ã –≤—ã–ø–∞–¥–µ–Ω–∏—è (%)</h4>
            <div class="chances-grid">
                <div><label style="color:#B0B0B0">–®–∏—Ä–ø</label><input type="number" step="0.01" id="chance-consumer"></div>
                <div><label style="color:#4CAF50">–û–±—ã—á–Ω—ã–π</label><input type="number" step="0.01" id="chance-common"></div>
                <div><label style="color:#2196F3">–†–µ–¥–∫–∏–π</label><input type="number" step="0.01" id="chance-rare"></div>
                <div><label style="color:#9C27B0">–≠–ø–∏–∫</label><input type="number" step="0.01" id="chance-epic"></div>
                <div><label style="color:#FFD700">–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π</label><input type="number" step="0.01" id="chance-legendary"></div>
                <div><label style="color:#FF0055">–ú–ò–§–ò–ß–ï–°–ö–ò–ô</label><input type="number" step="0.01" id="chance-mythical"></div>
            </div>

            <div style="background: #1a1a1a; padding: 10px; border-radius: 8px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="margin:0;">–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–µ–π—Å–∞</h4>
                    <button class="btn-green" style="width:auto; font-size:12px;" onclick="addLocalItem()">+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</button>
                </div>
                <div class="items-header"><span>IMG</span><span>–ù–∞–∑–≤–∞–Ω–∏–µ</span><span>–¶–µ–Ω–∞ (‚ÇΩ)</span><span>–†–µ–¥–∫–æ—Å—Ç—å</span><span>Del</span></div>
                <div id="items-container"></div>
            </div>
            
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-blue" onclick="saveCaseToDB()">üíæ –°–û–•–†–ê–ù–ò–¢–¨ –í –ë–ê–ó–£ –î–ê–ù–ù–´–•</button>
                <button class="btn-red" onclick="deleteCaseFromDB()" id="btn-delete-case">–£–¥–∞–ª–∏—Ç—å –ö–µ–π—Å</button>
            </div>
        </div>
    </div>

    <div class="container" id="view-promos" style="display:none; grid-template-columns: 1fr;">
        <div class="editor">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
                <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ –ü—Ä–æ–º–æ–∫–æ–¥—ã (DB)</h3>
                <button class="btn-blue" style="width:auto; padding: 10px 20px;" onclick="addPromo()">+ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–¥</button>
            </div>
            <div class="items-header" style="grid-template-columns: 2fr 1fr 1fr 40px;">
                <span>–ö–æ–¥ (–ü—Ä–∏–º–µ—Ä: BONUS)</span>
                <span>–°—É–º–º–∞ –Ω–∞–≥—Ä–∞–¥—ã (‚ÇΩ)</span>
                <span>–°—Ç–∞—Ç—É—Å (–í–∫–ª/–í—ã–∫–ª)</span>
                <span>Del</span>
            </div>
            <div id="promos-container">
                <div style="text-align:center; padding: 20px; color:#666;">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –∏–∑ –ë–î...</div>
            </div>
        </div>
    </div>

    <div class="container" id="view-broadcast" style="display:none; grid-template-columns: 1fr;">
        <div class="editor" style="max-width: 600px; margin: 0 auto;">
            <h3 style="margin-bottom: 20px;">üì¢ –†–∞—Å—Å—ã–ª–∫–∞ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</h3>
            <p style="color: #aaa; font-size: 13px; margin-bottom: 20px;">
                –°–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –±–æ—Ç–∞.
                –ü—Ä–æ—Ü–µ—Å—Å –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è. –ù–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ –≤–∫–ª–∞–¥–∫—É.
            </p>
            
            <label>–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:</label>
            <textarea id="broadcast-text" rows="5" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏..."></textarea>
            
            <div id="broadcast-status" style="margin: 15px 0; font-size: 13px; color: #FFD700; display:none;">
                –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: <span id="bc-sent">0</span> / <span id="bc-total">0</span>
            </div>

            <button class="btn-green" onclick="startBroadcast()" id="btn-broadcast">–ù–ê–ß–ê–¢–¨ –†–ê–°–°–´–õ–ö–£</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://itqlqsixknkqoggvubrp.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0cWxxc2l4a25rcW9nZ3Z1YnJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MjE3MDIsImV4cCI6MjA4NjQ5NzcwMn0.mV0As50_W8MBC3kpLYm_mLbExqRRyf8JaJi1eNOtAj4'; 
        // –í–°–¢–ê–í–¨ –°–Æ–î–ê –¢–û–¢ –ñ–ï API URL –ß–¢–û –ò –í SCRIPT.JS
        const API_URL = "https://script.google.com/macros/s/AKfycbwCTnYYNY3u9ceNdIxlBd0so2fWxNCzxgmQfuDntr3HuKRu9gK9cmGzkeui_Z-4HGQiqw/exec";
        
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const PLACEHOLDER_IMG = "https://placehold.co/100x100/1a1a1a/ffffff?text=No+Image";

        let dbCases = [];
        let dbItems = [];
        let promoData = [];
        let editingCaseId = null;
        let localItems = [];

        async function login() {
            const u = document.getElementById('admin-user').value;
            const p = document.getElementById('admin-pass').value;
            const { data, error } = await sb.from('admin_users').select('*').eq('username', u).eq('password', p).maybeSingle();
            if (data) {
                document.getElementById('login-overlay').style.display = 'none';
                initDashboard();
            } else {
                document.getElementById('login-error').innerText = "–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å";
            }
        }
        function logout() { location.reload(); }

        async function initDashboard() {
            await fetchAllData();
            await fetchPromosFromDB();
        }

        async function fetchAllData() {
            const { data: cData } = await sb.from('cases').select('*').order('id', { ascending: true });
            dbCases = cData || [];
            const { data: iData } = await sb.from('case_items').select('*');
            dbItems = iData || [];
            renderCasesList();
        }

        function renderCasesList() {
            const list = document.getElementById('cases-list'); list.innerHTML = '';
            dbCases.forEach((c) => {
                const btn = document.createElement('button');
                btn.className = `btn-item ${c.id === editingCaseId ? 'active' : ''}`;
                btn.innerHTML = `<div style="font-size:14px; font-weight:bold;">${c.name}</div><div style="font-size:11px; color:#888;">${c.price} ‚ÇΩ ‚Ä¢ [${c.category}] (ID: ${c.id})</div>`;
                btn.onclick = () => selectCaseForEdit(c.id);
                list.appendChild(btn);
            });
        }

        function createNewLocalCase() {
            editingCaseId = null; localItems = []; clearEditor();
            document.getElementById('editor-area').style.display = 'block';
            document.getElementById('btn-delete-case').style.display = 'none';
        }

        function selectCaseForEdit(id) {
            editingCaseId = id; const c = dbCases.find(x => x.id === id); if(!c) return;
            localItems = dbItems.filter(i => i.case_id === id).map(i => ({...i}));
            document.getElementById('case-name').value = c.name; document.getElementById('case-price').value = c.price; document.getElementById('case-category').value = c.category; document.getElementById('case-img').value = c.img; document.getElementById('case-img-preview').src = c.img;
            const ch = c.chances || {};
            ['consumer','common','rare','epic','legendary','mythical'].forEach(r => document.getElementById(`chance-${r}`).value = ch[r] || 0);
            renderEditorItems();
            document.getElementById('editor-area').style.display = 'block'; document.getElementById('btn-delete-case').style.display = 'block'; renderCasesList();
        }

        function clearEditor() {
            document.getElementById('case-name').value = "–ù–æ–≤—ã–π –ö–µ–π—Å"; document.getElementById('case-price').value = 100; document.getElementById('case-category').value = 'default'; document.getElementById('case-img').value = PLACEHOLDER_IMG; document.getElementById('case-img-preview').src = PLACEHOLDER_IMG;
            ['consumer','common','rare','epic','legendary','mythical'].forEach(r => document.getElementById(`chance-${r}`).value = 0);
            renderEditorItems();
        }

        function renderEditorItems() {
            const container = document.getElementById('items-container'); container.innerHTML = '';
            localItems.forEach((item, idx) => {
                const row = document.createElement('div'); row.className = `item-row border-${item.rarity}`;
                row.innerHTML = `<img src="${item.img}" class="item-img-preview" onerror="this.src='${PLACEHOLDER_IMG}'"><div><input type="text" value="${item.name}" onchange="localItems[${idx}].name = this.value" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"><input type="text" value="${item.img}" placeholder="URL –∫–∞—Ä—Ç–∏–Ω–∫–∏" style="font-size:10px; color:#888; margin:0;" onchange="localItems[${idx}].img = this.value"></div><input type="number" value="${item.price}" onchange="localItems[${idx}].price = parseInt(this.value)" placeholder="–¶–µ–Ω–∞"><select onchange="localItems[${idx}].rarity = this.value; renderEditorItems()"><option value="consumer" ${item.rarity==='consumer'?'selected':''}>–®–∏—Ä–ø (–°–µ—Ä—ã–π)</option><option value="common" ${item.rarity==='common'?'selected':''}>–û–±—ã—á–Ω—ã–π (–ó–µ–ª–µ–Ω—ã–π)</option><option value="rare" ${item.rarity==='rare'?'selected':''}>–†–µ–¥–∫–∏–π (–°–∏–Ω–∏–π)</option><option value="epic" ${item.rarity==='epic'?'selected':''}>–≠–ø–∏–∫ (–§–∏–æ–ª)</option><option value="legendary" ${item.rarity==='legendary'?'selected':''}>–õ–µ–≥–∞ (–ó–æ–ª–æ—Ç–æ)</option><option value="mythical" ${item.rarity==='mythical'?'selected':''}>–ú–ò–§ (–ö—Ä–∞—Å–Ω—ã–π)</option></select><button class="btn-red" style="width:100%; padding:8px;" onclick="removeLocalItem(${idx})">üóë</button>`;
                container.appendChild(row);
            });
        }

        function addLocalItem() { localItems.push({ name: "–ü—Ä–µ–¥–º–µ—Ç", price: 100, img: PLACEHOLDER_IMG, rarity: "common" }); renderEditorItems(); }
        function removeLocalItem(idx) { localItems.splice(idx, 1); renderEditorItems(); }
        function updatePreview() { document.getElementById('case-img-preview').src = document.getElementById('case-img').value; }

        async function saveCaseToDB() {
            const btn = document.querySelector('.btn-blue'); btn.disabled = true; btn.innerText = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
            const caseObj = { name: document.getElementById('case-name').value, price: parseInt(document.getElementById('case-price').value) || 0, category: document.getElementById('case-category').value, img: document.getElementById('case-img').value, chances: { consumer: parseFloat(document.getElementById('chance-consumer').value)||0, common: parseFloat(document.getElementById('chance-common').value)||0, rare: parseFloat(document.getElementById('chance-rare').value)||0, epic: parseFloat(document.getElementById('chance-epic').value)||0, legendary: parseFloat(document.getElementById('chance-legendary').value)||0, mythical: parseFloat(document.getElementById('chance-mythical').value)||0 } };
            let targetId = editingCaseId;
            try {
                if (targetId) await sb.from('cases').update(caseObj).eq('id', targetId);
                else { const { data, error } = await sb.from('cases').insert([caseObj]).select(); if(error) throw error; targetId = data[0].id; }
                await sb.from('case_items').delete().eq('case_id', targetId);
                if (localItems.length > 0) { const itemsToInsert = localItems.map(i => ({ case_id: targetId, name: i.name, price: i.price, img: i.img, rarity: i.rarity })); await sb.from('case_items').insert(itemsToInsert); }
                alert("–£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!"); await fetchAllData(); selectCaseForEdit(targetId);
            } catch(e) { alert("–û—à–∏–±–∫–∞: " + e.message); } finally { btn.disabled = false; btn.innerText = "üíæ –°–û–•–†–ê–ù–ò–¢–¨ –í –ë–ê–ó–£ –î–ê–ù–ù–´–•"; }
        }

        async function deleteCaseFromDB() {
            if(!editingCaseId || !confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–µ–π—Å?")) return;
            const { error } = await sb.from('cases').delete().eq('id', editingCaseId);
            if(error) alert("–û—à–∏–±–∫–∞: " + error.message); else { alert("–£–¥–∞–ª–µ–Ω–æ"); document.getElementById('editor-area').style.display = 'none'; fetchAllData(); }
        }

        async function fetchPromosFromDB() {
            const { data, error } = await sb.from('admin_promos').select('*').order('id', { ascending: true });
            if (!error) { promoData = data || []; renderPromos(); }
        }
        function renderPromos() {
            const container = document.getElementById('promos-container'); container.innerHTML = '';
            promoData.forEach((promo, idx) => {
                const row = document.createElement('div'); row.className = 'promo-row';
                row.innerHTML = `<input type="text" value="${promo.code}" onchange="updatePromoDB(${idx}, 'code', this.value.toUpperCase())" style="color:gold; font-weight:bold;"><input type="number" value="${promo.reward}" onchange="updatePromoDB(${idx}, 'reward', this.value)"><select onchange="updatePromoDB(${idx}, 'is_active', this.value === 'true')" style="color: ${promo.is_active ? '#4CAF50' : '#ff4d4d'}"><option value="true" ${promo.is_active ? 'selected' : ''}>–í–∫–ª</option><option value="false" ${!promo.is_active ? 'selected' : ''}>–í—ã–∫–ª</option></select><button class="btn-red" style="margin:0; padding:8px;" onclick="deletePromoDB(${idx})">üóë</button>`;
                container.appendChild(row);
            });
        }
        async function addPromo() { const { data, error } = await sb.from('admin_promos').insert([{ code: "NEW_CODE", reward: 100, is_active: true }]).select(); if(!error) { promoData.push(data[0]); renderPromos(); } }
        async function updatePromoDB(idx, field, val) { const p = promoData[idx]; if(field === 'reward') val = parseInt(val); const { error } = await sb.from('admin_promos').update({ [field]: val }).eq('id', p.id); if(!error) { p[field] = val; if(field==='is_active') renderPromos(); } }
        async function deletePromoDB(idx) { if(!confirm("–£–¥–∞–ª–∏—Ç—å?")) return; const p = promoData[idx]; const { error } = await sb.from('admin_promos').delete().eq('id', p.id); if(!error) { promoData.splice(idx, 1); renderPromos(); } }

        // --- BROADCAST LOGIC ---
        async function startBroadcast() {
            const text = document.getElementById('broadcast-text').value;
            if(!text) return alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç!");
            if(!confirm("–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º?")) return;

            const btn = document.getElementById('btn-broadcast');
            const statusDiv = document.getElementById('broadcast-status');
            const sentSpan = document.getElementById('bc-sent');
            const totalSpan = document.getElementById('bc-total');

            btn.disabled = true;
            statusDiv.style.display = 'block';

            // 1. Get all users
            const { data: users, error } = await sb.from('users').select('telegram_id');
            if(error || !users) return alert("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π");

            totalSpan.innerText = users.length;
            let sentCount = 0;

            // 2. Loop and send (with delay to avoid limits)
            for (let i = 0; i < users.length; i++) {
                const uid = users[i].telegram_id;
                
                try {
                    await fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            action: "broadcast_fast",
                            userId: uid,
                            text: text
                        })
                    });
                    sentCount++;
                    sentSpan.innerText = sentCount;
                } catch(e) {
                    console.error("Broadcast fail:", uid);
                }

                // Delay 100ms
                await new Promise(r => setTimeout(r, 100));
            }

            alert("–†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!");
            btn.disabled = false;
        }

        function setMode(mode) {
            document.getElementById('view-cases').style.display = mode === 'cases' ? 'grid' : 'none';
            document.getElementById('view-promos').style.display = mode === 'promos' ? 'grid' : 'none';
            document.getElementById('view-broadcast').style.display = mode === 'broadcast' ? 'grid' : 'none';
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-'+mode).classList.add('active');
        }
    </script>
</body>
</html>